/** @license smfplayer.js 2013 - imaya / GREE Inc. [ https://github.com/gree/smfplayer.js ] The MIT License */(function() {var t,u=this;function v(b,e){b=b.split(".");var f=u;b[0]in f||!f.execScript||f.execScript("var "+b[0]);for(var c;b.length&&(c=b.shift());)b.length||void 0===e?f[c]?f=f[c]:f=f[c]={}:f[c]=e}function w(b,e){function f(){}f.prototype=e.prototype;b.ra=e.prototype;b.prototype=new f;b.prototype.constructor=b;b.ma=function(c,a,b){for(var f=Array(arguments.length-2),g=2;g<arguments.length;g++)f[g-2]=arguments[g];return e.prototype[a].apply(c,f)}};function y(b,e){e=e||{};this.f=b;this.a=e.index||0;this.length=e.length||b.length-this.a;this.offset=this.a;this.padding=void 0!==e.padding?e.padding:!0;this.o=void 0!==e.o?e.o:!1}function z(b,e){b=b.b[e];return void 0===b?null:b};function A(b,e,f){this.h=b;this.U=e;this.time=f}function B(b,e,f,c,a,h){A.call(this,b,e,f);this.b=c;this.I=a;this.a=h}w(B,A);function C(b,e,f,c){A.call(this,b,e,f);this.data=c}w(C,A);function D(b,e,f,c){A.call(this,b,e,f);this.data=c}w(D,A);function F(b){var e=e||{};e.padding=!1;e.o=!0;this.b=b;this.f=0;this.a=new y(b,e);this.m=[];this.u=[]}
function G(b){function e(){var b=0;do{var d=c[a++];b=b<<7|d&127}while(0!==(d&128));return b}var f=z(b.a,b.f++),c=b.b,a=f.offset,h=-1,n=-1,g=0;if(!f||"MTrk"!==f.type)throw Error("invalid header signature");f=f.offset+f.size;for(var x=[],p=[];a<f;){var d=e();g+=d;var l=a;var q=c[a++];var k=q>>4&15;var r=q&15;8>k?(k=h,r=n,q=h<<4|n,a--,l--):(h=k,n=r);var E=[,,,,,,,,"NoteOff","NoteOn","NoteAftertouch","ControlChange","ProgramChange","ChannelAftertouch","PitchBend"];switch(k){case 8:case 9:case 10:case 11:case 13:case 14:var m=
new B(E[k],d,g,r,c[a++],c[a++]);break;case 12:m=new B(E[k],d,g,r,c[a++]);break;case 15:switch(r){case 0:m=e();if(247!==c[a+m-1])throw Error("invalid SysEx event");m=new C("SystemExclusive",d,g,c.subarray(a,(a+=m)-1));break;case 7:m=e();m=new C("SystemExclusive(F7)",d,g,c.subarray(a,a+=m));break;case 15:k=c[a++];m=e();switch(k){case 0:m=new D("SequenceNumber",d,g,[c[a++],c[a++]]);break;case 1:m=new D("TextEvent",d,g,[String.fromCharCode.apply(null,c.subarray(a,a+=m))]);break;case 2:m=new D("CopyrightNotice",
d,g,[String.fromCharCode.apply(null,c.subarray(a,a+=m))]);break;case 3:m=new D("SequenceTrackName",d,g,[String.fromCharCode.apply(null,c.subarray(a,a+=m))]);break;case 4:m=new D("InstrumentName",d,g,[String.fromCharCode.apply(null,c.subarray(a,a+=m))]);break;case 5:m=new D("Lyrics",d,g,[String.fromCharCode.apply(null,c.subarray(a,a+=m))]);break;case 6:m=new D("Marker",d,g,[String.fromCharCode.apply(null,c.subarray(a,a+=m))]);break;case 7:m=new D("CuePoint",d,g,[String.fromCharCode.apply(null,c.subarray(a,
a+=m))]);break;case 32:m=new D("MidiChannelPrefix",d,g,[c[a++]]);break;case 47:m=new D("EndOfTrack",d,g,[]);break;case 81:m=new D("SetTempo",d,g,[c[a++]<<16|c[a++]<<8|c[a++]]);break;case 84:m=new D("SmpteOffset",d,g,[c[a++],c[a++],c[a++],c[a++],c[a++]]);break;case 88:m=new D("TimeSignature",d,g,[c[a++],c[a++],c[a++],c[a++]]);break;case 89:m=new D("KeySignature",d,g,[c[a++],c[a++]]);break;case 127:m=new D("SequencerSpecific",d,g,[c.subarray(a,a+=m)]);break;default:m=new D("Unknown",d,g,[k,c.subarray(a,
a+=m)])}break;default:u.console.log("unknown message:",q.toString(16))}break;default:throw Error("invalid status");}d=a-l;l=c.subarray(l,l+d);l[0]=q;m instanceof B&&"NoteOn"===m.h&&0===m.a&&(m.h=E[8],l=new Uint8Array([128|m.b,m.I,m.a]));p.push(l);x.push(m)}b.m.push(x);b.u.push(p)};function H(b){var e=e||{};this.b=b;this.a=e.index||0}
function I(b){function e(){var b=c[a++]<<8|c[a++];b=a+b;var d=[];if(1!==c[a++])throw Error("invalid EditInstrument const value:"+c[a-1]);for(;a<b;){var e={};e.part=c[a++]>>4&3;e.modulator={ML:c[a]>>5,VIV:c[a]>>4&1,EG:c[a]>>3&1,SUS:c[a]>>2&1,RR:(c[a++]&3)<<2|c[a]>>6,DR:c[a]>>4&15,AR:(c[a++]&3)<<2|c[a]>>6,SL:c[a]>>4&15,TL:(c[a++]&3)<<4|c[a]>>4,WF:c[a]>>3&1,FB:c[a++]&7};e.carrier={ML:c[a]>>5,VIV:c[a]>>4&1,EG:c[a]>>3&1,SUS:c[a]>>2&1,RR:(c[a++]&3)<<2|c[a]>>6,DR:c[a]>>4&15,AR:(c[a++]&3)<<2|c[a]>>6,SL:c[a]>>
4&15,TL:(c[a++]&3)<<4|c[a]>>4,WF:c[a]>>3&1,FB:c[a++]&7};e.octaveSelect=c[a++]&3;d.push(e)}return d}function f(){var b=c[a++]<<8|c[a++];b=a+b;if(17!==c[a++])throw Error("invalid DeviceSpecific const value:"+c[a-1]);return{data:c.subarray(a,a+=b-a)}}var c=b.b,a=b.a,h=b.m=[],n,g;var x=0;for(g=b.g.v;x<g;++x){var p=String.fromCharCode(c[a++],c[a++],c[a++],c[a++]);if("trac"!==p)throw Error("invalid track signature:"+p);p=c[a++]<<24|c[a++]<<16|c[a++]<<8|c[a++];p=a+p;for(n=h[x]=[];a<p;){var d={key:null,length:null,
ba:null,c:null,type:null,value:{},ka:null,la:null};d.U=c[a++];var l=c[a++];if(255!==l)d.type="note",d.c="Note",d.la=l>>6,d.key=l&63,d.length=c[a++],1===b.f.qa&&(l=c[a++],d.ka=l>>2,d.ba=l&3);else switch(d.type="meta",l=c[a++],l>>4){case 11:switch(l&15){case 0:d.c="MasterVolume";d.value=c[a++];break;case 10:d.c="DrumScale";d.value={channel:c[a]>>3&7,drum:c[a++]&1};break;default:throw Error("unknown message type:"+l.toString(16));}break;case 12:d.c="SetTempo";d.value={timeBase:7===(l&7)?NaN:Math.pow(2,
l&7)*(0===(l&8)?6:15),tempo:c[a++]};break;case 13:switch(l&15){case 0:d.c="Point";d.value=c[a++];break;case 13:d.c="Loop";d.value={id:c[a]>>6,count:c[a]>>2&15,point:c[a++]&3};break;case 14:d.c="Nop";d.value=c[a++];break;case 15:d.c="EndOfTrack";d.value=c[a++];break;default:throw Error("unkwnon message type:"+l.toString(16));}break;case 14:switch(l&15){case 0:d.c="InstrumentLowPart";d.value={part:c[a]>>6,instrument:c[a++]&63};break;case 1:d.c="InstrumentHighPart";d.value={part:c[a]>>6,instrument:c[a++]&
1};break;case 2:d.c="Volume";d.value={part:c[a]>>6,volume:c[a++]&63};break;case 3:d.c="Valance";d.value={part:c[a]>>6,valance:c[a++]&63};break;case 4:d.c="PitchBend";d.value={part:c[a]>>6,value:c[a++]&63};break;case 5:d.c="ChannelAssign";d.value={part:c[a]>>6,channel:c[a++]&63};break;case 6:d.c="VolumeChange";d.value={part:c[a]>>6,volume:(c[a++]&63)<<26>>26};break;case 7:d.c="PitchBendRange";d.value={part:c[a]>>6,value:c[a++]&63};break;case 9:d.c="MasterCoarseTuning";d.value={part:c[a]>>6,value:c[a++]&
63};break;case 10:d.c="Modulation";d.value={part:c[a]>>6,depth:c[a++]&63};break;default:throw Error("unkwnon message type:"+l.toString(16));}break;case 15:switch(l&15){case 0:d.c="EditInstrument";d.value=e();break;case 1:d.c="Vibrato";l=d;a++;a++;if(1!==c[a++])throw Error("invalid Vibrato const value:"+c[a-1]);var q={part:c[a++]>>5&3,"switch":c[a++]>>6};l.value=q;break;case 15:d.c="DeviceSpecific";d.value=f();break;default:throw Error("unkwnon message type:"+l.toString(16));}break;default:throw Error("unkwnon message type:"+
l.toString(16));}n.push(d)}a=p}b.a=a}
function J(b){var e={M:48,sa:[],u:[]},f=e.m;e=e.u;var c=b.m,a,h,n,g,x,p=[];for(h=0;16>h;++h)e[h]=[],p[h]=0;h=0;for(n=c.length;h<n;++h){var d=c[h];var l=[];var q=a=g=0;for(x=d.length;g<x;++g){var k=d[g];q+=k.deltaTime;k.id=a;k.time=q;switch(k.subType){case "Nop":break;case "Note":l[a++]=k;l[a]={id:a,type:"internal",subType:"NoteOff",time:q+k.length,key:k.key,voice:k.voice,velocity:k.velocity,octaveShift:k.octaveShift};a++;break;case "InstrumentHighPart":var r=k;k=d[++g];if("InstrumentLowPart"!==k.subType)throw Error("broken instrument");
l[a]={id:a,type:"internal",subType:"ProgramChange",time:q,part:k.value.part,instrument:r.value.instrument<<6|k.value.instrument};a++;break;default:l[a++]=k}}l.sort(function(a,b){return a.time>b.time?1:a.time<b.time?-1:a.id>b.id?1:a.id<b.id?-1:0});f[h]=[];q=g=0;for(x=l.length;g<x;++g){k=l[g];q=k.time;switch(k.subType){case "Note":r=K(k.key+45,k.octaveShift);d=4*h+k.voice;9===d&&(r-=10);e[d].push(L(q-p[d]).concat(144|d,r,2*k.velocity));break;case "NoteOff":r=K(k.key+45,k.octaveShift);d=4*h+k.voice;
9===d&&(r-=10);e[d].push(L(q-p[d]).concat(128|d,r,2*k.velocity));break;case "ProgramChange":d=4*h+k.part;e[d].push(L(q-p[d]).concat(192|d,k.instrument));break;case "SetTempo":r=288E7/(k.value.tempo*k.value.timeBase);d=0;e[d].push(L(q-p[d]).concat(255,81,3,r>>16&255,r>>8&255,r&255));break;case "Loop":r=k.value.count;r="LOOP_"+(0===k.value.point?"START":"END")+"=ID:"+k.value.id+",COUNT:"+(0===r?-1:r);d=0;e[d].push(L(q-p[d]).concat([255,6,r.length],r.split("").map(function(a){return a.charCodeAt(0)})));
break;case "MasterVolume":r=k.value;d=0;e[d].push(L(q-p[d]).concat(240,7,127,127,4,1,r,r,247));break;case "Modulation":d=4*h+k.value.part;e[d].push(L(q-p[d]).concat(176|d,1,2*k.value.depth));break;case "Volume":d=4*h+k.value.part;e[d].push(L(q-p[d]).concat(176|d,7,2*k.value.volume));break;case "Valance":d=4*h+k.value.part;e[d].push(L(q-p[d]).concat(176|d,10,2*(k.value.valance-32)+64));break;case "PitchBend":d=4*h+k.value.part;e[d].push(L(q-p[d]).concat(224|d,2*k.value.value,2*k.value.value));break;
case "PitchBendRange":d=4*h+k.value.part;e[d].push(L(q-p[d]).concat(176|d,100,0),[0,176|d,101,0],[0,176|d,6,2*k.value.value]);break;case "MasterCoarseTuning":d=4*h+k.value.part;e[d].push(L(q-p[d]).concat(176|d,100,0),[0,176|d,101,2],[0,176|d,6,2*k.value.value]);break;default:continue}p[d]=k.time}}return M(b,e)}function K(b,e){var f=[0,12,-24,-12];if(void 0!==f[e])return b+f[e];throw Error("invalid OctaveShift value:"+e);}
function M(b,e){var f,c=[77,84,104,100,0,0,0,6,0,1,0,16,0,48],a;if(void 0!==b.f.copy){b=b.f.copy;var h=b.length;var n=Array(h);for(f=0;f<h;++f)n[f]=b.charCodeAt(f);f=n;b=f.length;f=[0,255,2].concat(L(b),f);e[0].unshift(f)}h=0;for(b=e.length;h<b;++h){var g=e[h];f=[];n=0;for(a=g.length;n<a;++n)Array.prototype.push.apply(f,g[n]);a=f.length;n=[77,84,114,107,a>>24&255,a>>16&255,a>>8&255,a&255];c=c.concat(n,f)}return new Uint8Array(c)}
function L(b){for(var e=[];128<=b;)e.unshift(b&127|(0===e.length?0:128)),b>>>=7;e.unshift(b|(0===e.length?0:128));return e};function N(b){this.j=5E5;this.f=!0;this.s=!1;this.b=0;this.J=this.N=this.H=this.G=!1;this.A=1;this.O=16383;this.window=u.window;this.target=document.body.querySelector(void 0===b?"#wml":b)}t=N.prototype;t.da=function(b){this.G=b};t.ea=function(b){this.H=b};t.ga=function(b){this.N=b};t.fa=function(b){this.J=b};t.C=function(){var b;this.f=!0;this.i=Date.now();if(this.a)for(b=0;16>b;++b)this.a.contentWindow.postMessage("midi,b"+b.toString(16)+",78,0","*")};t.$=function(){return this.a};
function O(b){b.C();P(b);b.f=!0;b.g=null;b.i=-1;b.P=null;b.w=null;b.D=null;b.length=0;b.b=0;b.time=0;b.B=0;b.window.clearTimeout(b.l);b.s?Q(b):b.window.addEventListener("message",function(e){"link,ready"===e.data&&Q(b)},!1)}function P(b){b.j=5E5;b.b=0;Q(b);b.f=!1}
t.S=function(){var b=this;if(!this.a)throw Error("WebMidiLink not found");this.s?this.g?(this.length=this.g.length,this.g instanceof Array&&this.b>=this.length&&(this.b=0),R(this)):u.console.warn("Midi file is not loaded."):this.window.addEventListener("message",function(e){"link,ready"===e.data&&(b.s=!0,R(b))},!1)};
function Q(b){var e=b.a.contentWindow,f;for(f=0;16>f;++f)e.postMessage("midi,b"+f.toString(16)+",128,0","*"),e.postMessage("midi,b"+f.toString(16)+",07,64","*"),e.postMessage("midi,b"+f.toString(16)+",0a,40","*"),e.postMessage("midi,e"+f.toString(16)+",00,40","*"),e.postMessage("midi,b"+f.toString(16)+",64,00","*"),e.postMessage("midi,b"+f.toString(16)+",65,00","*"),e.postMessage("midi,b"+f.toString(16)+",06,02","*"),e.postMessage("midi,b"+f.toString(16)+",26,00","*");b.K()}
t.ia=function(b){b=void 0===b?"//cdn.rawgit.com/logue/smfplayer.js/gh-pages/wml.html":b;var e=this;this.a&&this.a.parentNode.removeChild(this.a);this.target.firstChild&&this.target.removeChild(this.target.firstChild);var f=this.a=this.window.document.createElement("iframe");f.src=b;f.className="wml";this.target.appendChild(f);this.window.addEventListener("message",function(b){"string"===typeof b.data&&(b=b.data.split(","),"link"===b[0]&&("ready"===b[1]?(e.s=!0,e.loaded=100,e.L(e.O)):"progress"===
b[1]&&(e.loaded=Math.round(b[2]/b[3]*1E4))))},!1)};t.L=function(b){this.O=b;this.a&&this.a.contentWindow.postMessage("midi,f0,7f,7f,04,01,"+[("0"+(b&127).toString(16)).substr(-2),("0"+(b>>7&127).toString(16)).substr(-2),"7f"].join(),"*")};t.ha=function(b){this.A=b};
function R(b){function e(){var b=a[n].time,p=a.length,d=Date.now();if(f.f)f.i=Date.now()-f.i;else{do{var l=a[n].event;"SetTempo"===l.h&&(f.j=l.data[0]);"ControlChange"===l.h&&111===l.I&&(g[0]={pos:n});if("Marker"===l.h&&("A"===l.data[0]&&(g[0]={pos:n}),"B"===l.data[0]&&f.H&&g[0]&&"number"===typeof g[0].pos)){n=g[0].pos;f.l=f.window.setTimeout(e,0);f.b=n;return}if("Marker"===l.h&&(l=l.data[0].match(/^LOOP_(START|END)=ID:(\d+),COUNT:(-?\d+)$/)))if("START"===l[1])g[l[2]|0]=g[l[2]]||{pos:n,count:l[3]|
0};else if("END"===l[1]&&f.N){var q=g[l[2]|0];if(0!==q.count){0<q.count&&q.count--;n=q.pos;f.l=f.window.setTimeout(e,0);f.b=n;return}g[l[2]|0]=null}h.postMessage(a[n++].webMidiLink,"*")}while(n<p&&a[n].time===b);n<p?(d=Date.now()-d,f.l=f.window.setTimeout(e,f.j/(1E3*c)*(a[n].time-b-d)*(1/f.A))):(f.window.postMessage("endoftrack","*"),f.f=!0,f.G&&g[0]&&"number"===typeof g[0].pos?n=g[0].pos:f.J&&(P(f),R(f)));f.b=n;f.time=b}}var f=b,c=b.P.M,a=b.g,h=b.a.contentWindow,n=b.b||0,g=[];b.f?(b.l=b.window.setTimeout(e,
b.i),b.f=!1,b.i=-1):b.l=b.window.setTimeout(e,b.j/1E3*c*b.g[0].time)}
t.F=function(b){b=new F(b);O(this);var e=b.a;var f=e.length+e.offset;for(e.b=[];e.a<f;){var c=e;var a=c.f;var h=c.a;c.b.push({type:String.fromCharCode(a[h++],a[h++],a[h++],a[h++]),size:a=c.o?(a[h++]<<24|a[h++]<<16|a[h++]<<8|a[h++])>>>0:(a[h++]|a[h++]<<8|a[h++]<<16|a[h++]<<24)>>>0,offset:h});h+=a;c.padding&&1===(h-c.offset&1)&&h++;c.a=h}e=z(b.a,b.f++);f=b.b;c=e.offset;if(!e||"MThd"!==e.type)throw Error("invalid header signature");b.V=f[c++]<<8|f[c++];b.v=f[c++]<<8|f[c++];b.M=f[c++]<<8|f[c++];e=0;for(f=
b.v;e<f;++e)G(b);S(this,b)};
t.aa=function(b){b=new H(b);O(this);var e=b.b,f=b.a,c=b.g={},a=String.fromCharCode(e[f++],e[f++],e[f++],e[f++]);if("melo"!==a)throw Error("invalid MFi signature:"+a);c.pa=(e[f++]<<24|e[f++]<<16|e[f++]<<8|e[f++])>>>0;c.ja=(e[f++]<<16|e[f++])+f;c.na=e[f++];c.oa=e[f++];c.v=e[f++];b.a=f;e=b.b;f=b.a;c=b.f={copy:null,date:null,exst:null,note:null,prot:null,sorc:null,titl:null,trac:null,vers:null};for(var h;f<b.g.ja;)switch(a=String.fromCharCode(e[f++],e[f++],e[f++],e[f++]),h=e[f++]<<8|e[f++],a){case "titl":case "copy":case "vers":case "date":case "prot":c[a]=
String.fromCharCode.apply(null,e.subarray(f,f+=h));break;case "sorc":c[a]=e[f++];break;case "note":c[a]=e[f++]<<8|e[f++];break;case "exst":break;default:c[a]=e.subarray(f,f+=h)}b.a=f;I(b);this.F(J(b))};
function S(b,e){var f=b.g=[],c=b.D=[],a,h;var n=e.m;var g=Array(n.length);var x=e.u;var p=0;for(a=n.length;p<a;++p)g[p]=0;p=0;for(a=n.length;p<a;++p){g=n[p];var d=0;for(h=g.length;d<h;++d)0===e.V&&"SequenceTrackName"===g[d].h&&(b.w=g[d].data[0]),"CopyrightNotice"===g[d].h&&c.push(g[d].data[0]),f.push({track:p,eventId:d,time:g[d].time,event:g[d],webMidiLink:"midi,"+Array.prototype.map.call(x[p][d],function(a){return a.toString(16)}).join(",")})}f.sort(function(a,b){return a.time>b.time?1:a.time<b.time?
-1:a.track>b.track?1:a.track<b.track?-1:a.eventId>b.eventId?1:a.eventId<b.eventId?-1:0});b.B=f.slice(-1)[0].time;b.P=e}t.Z=function(){return this.w};t.W=function(){return this.D};t.Y=function(){return this.b};t.T=function(b){this.b=b};t.X=function(){return this.length};t.K=function(){this.a&&this.a.contentWindow.postMessage("midi,F0,7E,7F,09,01,F7","*")};t.ca=function(){this.a&&this.a.contentWindow.postMessage("midi,b0,78,0","*")};
t.R=function(b){b*=this.j/6E6;var e=b%3600;return Math.floor(b/3600)+":"+("00"+Math.floor(e/60)).slice(-2)+":"+("00"+Math.ceil(e%60)).slice(-2)};v("SMF.Player",N);v("SMF.Player.prototype.play",N.prototype.S);v("SMF.Player.prototype.stop",N.prototype.C);v("SMF.Player.prototype.loadMidiFile",N.prototype.F);v("SMF.Player.prototype.loadMldFile",N.prototype.aa);v("SMF.Player.prototype.setLoop",N.prototype.fa);v("SMF.Player.prototype.setCC111Loop",N.prototype.da);v("SMF.Player.prototype.setFalcomLoop",N.prototype.ea);v("SMF.Player.prototype.setMFiLoop",N.prototype.ga);v("SMF.Player.prototype.setWebMidiLink",N.prototype.ia);
v("SMF.Player.prototype.getWebMidiLink",N.prototype.$);v("SMF.Player.prototype.setTempoRate",N.prototype.ha);v("SMF.Player.prototype.setMasterVolume",N.prototype.L);v("SMF.Player.prototype.getCopyright",N.prototype.W);v("SMF.Player.prototype.getSequenceName",N.prototype.Z);v("SMF.Player.prototype.getLength",N.prototype.X);v("SMF.Player.prototype.setPosition",N.prototype.T);v("SMF.Player.prototype.getPosition",N.prototype.Y);v("SMF.Player.prototype.sendGmReset",N.prototype.K);
v("SMF.Player.prototype.sendAllSoundOff",N.prototype.ca);v("SMF.Player.prototype.time",N.prototype.time);v("SMF.Player.prototype.timeTotal",N.prototype.B);v("SMF.Player.prototype.getTime",N.prototype.R);}).call(this); //# sourceMappingURL=smf.player.min.js.map
